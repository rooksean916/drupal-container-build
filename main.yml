---
- hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # Whether to build the arm version of the container.
    build_arm: true

  tasks:
    - name: Build the x86 Docker image from the main Dockerfile.
      docker_image:
        path: ./
        nocache: yes
        name: geerlingguy/drupal
        tag: latest

    - name: Copy entrypoint into arm32v7 folder temporarily.
      copy:
        src: docker-entrypoint.sh
        dest: arm32v7/docker-entrypoint.sh
        mode: 0755

    - name: Build the arm32v7 Docker image from the arm Dockerfile.
      docker_image:
        path: ./arm32v7/
        nocache: yes
        name: geerlingguy/drupal
        tag: latest-arm32v7
      when: build_arm

    - name: Remove temporary entrypoint file.
      file:
        path: arm32v7/docker-entrypoint.sh
        state: absent